"use strict";function drawMatrix(t){function r(t){d3.select(this).selectAll(".cell").data(t.filter(function(t){return t.z})).enter().append("rect").attr("class","cell").attr("x",function(t){return c(t.x)}).attr("width",c.rangeBand()).attr("height",c.rangeBand()).style("fill-opacity",function(t){return i(t.z)}).style("fill",function(t){return f[t.x].group==f[t.y].group?u(f[t.x].group):null}).on("mouseover",a).on("mouseout",e)}function a(t){d3.selectAll(".row text").classed("active",function(r,a){return a==t.y}),d3.selectAll(".column text").classed("active",function(r,a){return a==t.x})}function e(){d3.selectAll("text").classed("active",!1)}function n(t){c.domain(m[t]);var r=d.transition().duration(2500);r.selectAll(".row").delay(function(t,r){return 4*c(r)}).attr("transform",function(t,r){return"translate(0,"+c(r)+")"}).selectAll(".cell").delay(function(t){return 4*c(t.x)}).attr("x",function(t){return c(t.x)}),r.selectAll(".column").delay(function(t,r){return 4*c(r)}).attr("transform",function(t,r){return"translate("+c(r)+")rotate(-90)"})}var o={top:80,right:80,bottom:10,left:80},l=720,s=720,c=d3.scale.ordinal().rangeBands([0,l]),i=d3.scale.linear().domain([0,4]).clamp(!0),u=d3.scale.category10().domain(d3.range(10)),d=d3.select("#graph").append("svg").attr("width",l+o.left+o.right).attr("height",s+o.top+o.bottom).style("margin-left",-o.left+"px").append("g").attr("transform","translate("+o.left+","+o.top+")"),p=[],f=d3.values(t.nodes),g=f.length;f.forEach(function(t,r){t.index=r,t.count=0,p[r]=d3.range(g).map(function(t){return{x:t,y:r,z:0}})}),t.links.forEach(function(t){p[t.source.index][t.target.index].z+=1,p[t.target.index][t.source.index].z+=1,p[t.source.index][t.source.index].z+=1,p[t.target.index][t.target.index].z+=1,f[t.source.index].count+=1,f[t.target.index].count+=1});var m={name:d3.range(g).sort(function(t,r){return d3.ascending(f[t].name,f[r].name)}),count:d3.range(g).sort(function(t,r){return f[r].count-f[t].count}),group:d3.range(g).sort(function(t,r){return f[r].group-f[t].group})};c.domain(m.name),d.append("rect").attr("class","background").attr("width",l).attr("height",s);var r=d.selectAll(".row").data(p).enter().append("g").attr("class","row").attr("transform",function(t,r){return"translate(0,"+c(r)+")"}).each(r);r.append("line").attr("x2",l),r.append("text").attr("x",6).attr("y",c.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,r){return f[r].path});var h=d.selectAll(".column").data(p).enter().append("g").attr("class","column").attr("transform",function(t,r){return"translate("+c(r)+")rotate(-90)"});h.append("line").attr("x1",-l),h.append("text").attr("x",6).attr("y",c.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,r){return f[r].path}),d3.select("#order").on("change",function(){clearTimeout(v),n(this.value)});var v=setTimeout(function(){n("count")},5e3)}function parseResponse(t){function r(t,r,a){return{source:t,target:r,type:o(a)}}function a(t,a,e){n(t,function(t,o){n(o,function(t,n){a.push(r(e,t,n))})})}function e(t,r,a,e){return{address:t.slice("http://".length),path:r.slice(a.length),fullPath:r,status:o(e.status)}}function n(t,r){for(var a in t)t.hasOwnProperty(a)&&r(a,t[a])}function o(t){return"UP"==t?"working":"broken"}function l(t){if(t.length<2)return"";var r=t.map(function(t){return t[0]}),a=!!r.reduce(function(t,r){return t===r?t:!1});if(a){var e=t.map(function(t){return t.slice(1)});return t[0][0]+l(e)}return""}var s={},c=[],i=l(Object.keys(t));return n(t,function(t,r){n(r,function(r,n){s[r]=e(r,t,i,n);var o=n.collaborators;a(o,c,r)})}),c.forEach(function(t){t.source=s[t.source],t.target=s[t.target]}),{nodes:s,links:c}}function draw(t){function r(t){d3.select(this).classed("fixed",t.fixed=!1),force.resume()}function a(t){d3.select(this).transition().duration(350).attr("r",16)}function e(t){d3.select(this).transition().duration(350).attr("r",8)}function n(t){d3.select(this).classed("fixed",t.fixed=!0),t.center=!1}function o(){g.attr("d",l),h.attr("transform",s),v.attr("transform",s),b.attr("transform",s)}function l(t){var r=t.target.x-t.source.x,a=t.target.y-t.source.y,e=Math.sqrt(r*r+a*a);return"M"+t.source.x+","+t.source.y+"A"+e+","+e+" 0 0,1 "+t.target.x+","+t.target.y}function s(t){return t.center&&(t.fixed=!1,t.x=(299*t.x+u/2)/300,t.y=(299*t.y+d/2)/300,(t.y-d/2)*(t.y-d/2)<2500&&(t.x-u/2)*(t.x-u/2)<2500?(t.center=!1,$("[id="+t.fullPath.split("/").join("_")+"]").attr("class",t.status)):force.alpha(.01)),"translate("+t.x+","+t.y+")"}var c=t.nodes,i=t.links,u=$("#graph").innerWidth(),d=window.innerHeight-80;force=d3.layout.force().nodes(d3.values(c)).links(i).size([u,d]).linkDistance(120).charge(-2e3).gravity(.2).friction(.5).on("tick",o).start();var p=function(t){var r=angular.element($("#panel")).scope();r.current.collaborator=t,r.$apply(),console.log(t)},f=d3.select("#graph").append("svg").attr("width",u).attr("height",d);f.append("defs").selectAll("marker").data(["broken","working"]).enter().append("marker").attr("id",function(t){return t}).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",-1.5).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L8,0L0,5");var g=f.append("g").selectAll("path").data(force.links()).enter().append("path").attr("class",function(t){return"link "+t.type}).attr("marker-end",function(t){return"url(#"+t.type+")"}),m=force.drag().on("dragstart",n),h=f.append("g").selectAll("circle").data(force.nodes()).enter().append("circle").attr("r",8).attr("class",function(t){return t.status}).attr("id",function(t){return t.fullPath.split("/").join("_")}).on("click",p).on("mouseover",a).on("mouseout",e).on("dblclick",r).call(m),v=f.append("g").selectAll("text").data(force.nodes()).enter().append("text").attr("x",10).attr("y","-0.3em").text(function(t){return t.path}),b=f.append("g").selectAll("text").data(force.nodes()).enter().append("text").attr("x",10).attr("y","1.1em").text(function(t){return t.address})}var force;angular.module("microInfraView",["restangular","ui.router","ui.bootstrap"]).config(["$stateProvider","$urlRouterProvider",function(t,r){t.state("home",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"}).state("matrix",{url:"/matrix",templateUrl:"app/matrix/collaborators.html",controller:"CollaboratorsMatrixCtrl"}),r.otherwise("/")}]),angular.module("microInfraView").directive("collaboratorStatus",function(){return{restrict:"E",templateUrl:"app/components/status/collaborator-status.html",scope:{status:"="}}}),angular.module("microInfraView").controller("NavbarCtrl",["$scope","$state",function(t,r){t.state=r.current.name}]),angular.module("microInfraView").directive("menu",function(){return{restrict:"E",templateUrl:"app/components/menu/menu.html",scope:{allCollaborators:"=",current:"=",parsedResponse:"="},controller:["$scope",function(t){t.select=function(r){t.current.collaborator=t.allCollaborators[r];for(var a in t.parsedResponse.nodes)t.parsedResponse.nodes[a].fullPath===r&&(t.current.collaborator=t.parsedResponse.nodes[a],d3.select(t.current.collaborator)[0][0].center=!0,console.log(d3.select(t.current.collaborator)[0][0]),$("[id="+r.split("/").join("_")+"]").attr("class","highlight"+t.current.collaborator.status),force.resume())}}]}}),angular.module("microInfraView").controller("CollaboratorsMatrixCtrl",["$scope","$log","Restangular",function(t,r,a){a.all("collaborators").one("all").get().then(function(r){t.current={collaborator:{}},t.allCollaborators=r.plain(),drawMatrix(parseResponse(t.allCollaborators))})}]),angular.module("microInfraView").controller("MainCtrl",["$scope","$log","Restangular",function(t,r,a){a.all("collaborators").one("all").get().then(function(r){t.current={collaborator:{}},t.allCollaborators=r.plain(),t.parsedResponse=parseResponse(t.allCollaborators),draw(t.parsedResponse)})}]),angular.module("microInfraView").run(["$templateCache",function(t){t.put("app/main/main.html",'<div ng-include="\'app/components/navbar/navbar.html\'"></div><div class="col-xs-12 col-md-3"><menu all-collaborators="allCollaborators" current="current" parsed-response="parsedResponse"></menu></div><div class="col-xs-12 col-sm-9 col-md-6"><div id="graph"></div></div><div class="col-xs-12 col-sm-3 col-md-3"><div class="panel panel-default" id="panel"><div class="panel-heading">Collaborator details</div><div class="panel-body"><span ng-show="!current.collaborator.address && !current.collaborator.path && !current.collaborator.status">Please select node</span><dl><dt ng-show="current.collaborator.path">Path</dt><dd ng-show="current.collaborator.path">{{current.collaborator.path}}</dd><dt ng-show="current.collaborator.status">Status</dt><dd ng-show="current.collaborator.status"><collaborator-status status="current.collaborator.status"></collaborator-status></dd><dt ng-show="current.collaborator.address">Address</dt><dd ng-show="current.collaborator.address">{{current.collaborator.address}}</dd><dt ng-show="current.collaborator.address">Swagger</dt><dd ng-show="current.collaborator.address"><a href="http://{{current.collaborator.address}}/swagger">{{current.collaborator.address}}/swagger</a></dd></dl></div></div></div>'),t.put("app/matrix/collaborators.html",'<div ng-include="\'app/components/navbar/navbar.html\'"></div><div class="col-xs-12"><div id="graph"></div></div>'),t.put("app/components/menu/menu.html",'<ul class="nav nav-pills nav-stacked" ng-repeat="(collaborator, definition) in allCollaborators"><li ng-class="{\'active\': collaborator===current.collaborator.fullPath}"><a ng-click="select(collaborator)">{{collaborator}}</a></li></ul>'),t.put("app/components/navbar/navbar.html",'<nav class="navbar navbar-static-top navbar-inverse" ng-controller="NavbarCtrl"><div class="container-fluid"><div class="navbar-header"><a class="navbar-brand" href="#/">Collaborators</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-6"><ul class="nav navbar-nav"><li ng-class="{\'active\': state==\'home\'}"><a ng-href="#/">Graph</a></li><li ng-class="{\'active\': state==\'matrix\'}"><a ng-href="#/matrix">Adjacency matrix</a></li></ul></div></div></nav>'),t.put("app/components/status/collaborator-status.html","<span class=\"label label-default\" ng-class=\"{'label-success': status=='working', 'label-danger': status!='working'}\">{{status | uppercase}}</span>")}]);